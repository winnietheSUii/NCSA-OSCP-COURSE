# 5-Post-Exploitation

Post-exploitation techniques including privilege escalation and system hardening bypass.

## Topics Covered

- **Privilege Escalation**: Linux and Windows privilege escalation techniques
- **SetUID Exploitation**: Abusing SetUID binaries for privilege escalation
- **Crontab Abuse**: Cron job manipulation for privilege escalation
- **Race Conditions**: Time-of-check-to-time-of-use vulnerabilities
- **Password Attacks**: Credential harvesting and cracking
- **Persistence**: Maintaining access after initial compromise
- **Lateral Movement**: Moving between systems on a network

## Privilege Escalation

### Linux Privilege Escalation

```bash
# Enumerate system information
uname -a
cat /etc/os-release
whoami
id
groups

# Check for SUID binaries
find / -perm -4000 2>/dev/null

# Check crontab
cat /etc/crontab
ls -la /etc/cron.d/

# Check sudoers
sudo -l

# Check for writable files in system directories
find / -writable 2>/dev/null | grep -E "^/etc|^/usr/local"

# Check for vulnerable kernel
uname -r

# Examine running processes
ps aux
ps auxf  # tree view
```

### SetUID Exploitation

```bash
# Find SetUID binaries
find / -perm -4000 -type f 2>/dev/null

# Identify vulnerable SetUID binaries
# Common vulnerable binaries:
# - /bin/su
# - /bin/passwd
# - /usr/bin/sudo
# - Custom applications

# Exploitation depends on the binary:
# For /bin/sh with SetUID:
/bin/sh -p

# For other binaries, identify the vulnerability (buffer overflow, path traversal, etc.)
```

### Crontab Abuse

```bash
# View crontabs
cat /etc/crontab
crontab -l

# Check cron.d directory
ls -la /etc/cron.d/
ls -la /etc/cron.daily/
ls -la /etc/cron.hourly/

# Create malicious cron job (if you have write permissions)
echo "* * * * * /path/to/reverse/shell.sh" | crontab -

# Exploit writable scripts called by cron
# Find scripts that are called by root's crontab
# Then modify them if they're writable
```

### Race Conditions

```bash
# Identify files accessed multiple times in succession
# Classic example: temporary file creation

# Check creation of /tmp files in cron jobs
# Window between check and use can be exploited

# Exploitation:
# 1. Predict temporary filename
# 2. Create symbolic link at that location
# 3. Trigger the vulnerable operation
# 4. Your linked target gets modified with root privileges
```

## Post-Exploitation Data Gathering

```bash
# Dump password hashes
cat /etc/shadow

# Extract SSH keys
find / -name "id_rsa" 2>/dev/null
find / -name "authorized_keys" 2>/dev/null

# Find saved credentials
grep -r "password\|passwd" /home/* 2>/dev/null

# Check browser history and cache
ls -la /home/*/.mozilla/
ls -la /home/*/.config/google-chrome/

# Extract bash history
cat ~/.bash_history
cat /home/*/.bash_history
```

## Lateral Movement

```bash
# Discover other hosts on the network
arp -a
ip neigh show

# Port scanning from compromised host
nc -zv [IP] 22 23 80 443
nmap [IP] (if available)

# Check for credential reuse
ssh-keyscan [TARGET_IP]
ssh user@[TARGET_IP] (try gathered credentials)

# Use SSH forwarding
ssh -N -L 8080:internal-ip:8080 user@[JUMP_HOST]
```

## Quick Commands

```bash
# Find privilege escalation content
grep -r "privilege\|escalation\|priv" . --include="*.md"

# Find SetUID related
grep -r "SetUID\|setuid" . --include="*.md"

# Find crontab topics
grep -r "crontab\|cron" . --include="*.md"

# Find race condition content
grep -r "race condition\|race" . --include="*.md"

# Find password-related
grep -r "password\|creds\|credential" . --include="*.md"
```

## Exploitation Workflow

1. **Initial Access**: Execute payload or gain shell access
2. **Enumeration**: Gather system information
3. **Exploitation**: Find and exploit privilege escalation vector
4. **Privilege Escalation**: Achieve root/SYSTEM access
5. **Persistence**: Maintain access for future use
6. **Data Exfiltration**: Gather sensitive information
7. **Lateral Movement**: Access other systems

## Common Privilege Escalation Vectors

### Kernel Exploits
- Vulnerable kernel versions
- Unpatched systems
- Check with: `uname -r` and searchsploit

### Misconfigured sudo
- `sudo -l` to check permissions
- NOPASSWD entries
- Wildcards in commands

### Writable System Files
- /etc/passwd writable
- /etc/crontab writable
- /var/log/* writable

### Vulnerable Applications
- Database applications
- Web servers running as root
- Custom applications with vulnerabilities

## Linux Privilege Escalation Scripts

Automated tools for enumeration:
```bash
# LinEnum
./LinEnum.sh

# Privilege Escalation Suggestor
./suggest-privesc.sh

# Lynis (Security audit)
lynis audit system
```

## Important Notes

⚠️ **Careful Exploitation**
- Each exploitation method is context-specific
- Test thoroughly in lab environment first
- Document all changes made
- Have exit strategy in place

## Prerequisites

- Shell access to target system
- Basic Linux/Windows command knowledge
- Understanding of privilege levels
- Knowledge of common vulnerabilities

## Learning Path

1. Master system enumeration
2. Learn privilege escalation vectors
3. Study specific exploitation techniques
4. Practice lateral movement
5. Develop persistence mechanisms

## Prevention and Hardening

```bash
# Check for and remove unnecessary SUID binaries
find / -perm -4000 -type f 2>/dev/null | audit

# Update kernel and applications regularly
apt update && apt upgrade

# Restrict sudo permissions
visudo  # carefully configure sudoers

# Monitor cron jobs
auditctl -w /etc/crontab -p wa

# File integrity monitoring
aide --init
aide --check
```
